<div class="container-fluid p-0">
 <!-- Search Section - Collapsible on Mobile -->
<div class="row justify-content-center">
  <div class="col-12 my-2">
    <!-- Toggle button for mobile -->
    <button class="btn btn-outline-secondary w-100 d-md-none mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#searchCollapse">
      <i class="bi bi-search"></i> Search & Filter
    </button>

    <!-- Collapsible search form -->
    <div class="collapse d-md-block" id="searchCollapse">
      <div class="appointments-search">
        <%= form_with url: dog_appointments_path,
                      method: :get,
                      data: {
                        turbo_frame: "appointments_list",
                        turbo_action: "advance",
                        controller: "search-form"
                      },
                      class: "row g-2" do %>

          <div class="col-12 col-md-5">
            <%= text_field_tag :query,
                  params[:query],
                  class: "form-control",
                  placeholder: "Search keywords...",
                  data: { action: "input->search-form#submit" }
              %>
          </div>

          <div class="col-12 col-md-4">
            <%= select_tag :appointment_type,
                options_for_select([
                  ['All Categories', 'all'],
                  ['Grooming', 'Grooming'],
                  ['Veterinarian', 'Veterinarian'],
                  ['Dogwalker', 'Dogwalker'],
                  ['Playdate', 'Playdate'],
                  ['Other', 'Other']
                ], params[:appointment_type] || 'all'),
                class: "form-select",
                data: { action: "change->search-form#submit" } %>
          </div>

          <div class="col-6 col-md-2">
            <%= submit_tag "Search", name: "", class: "btn btn-primary w-100" %>
          </div>

          <div class="col-6 col-md-1">
            <%= link_to "Close",
                dog_appointments_path,
                class: "btn btn-secondary w-100",
                data: { turbo_frame: "appointments_list" } %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

  <!-- Header and Calendar Section -->
  <div class="px-2 py-2">
    <div class="appointments-header">
      <div>
        <h1>Puppointments</h1>
        <p>Tap a time slot to create an appointment</p>
      </div>
        <div class="d-flex gap-3 align-items-center">
        <%= link_to new_dog_appointment_path(@dog), class: "text-dark" do %>
          <i class="fa-solid fa-plus icon"></i>
        <% end %>
      </div>
      </div>
      </div>

    </div>
    <div id='calendar'></div>
  </div>
</div>

<!-- Modal for creating new appointment -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Appointment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <%= form_with model: [@dog, Appointment.new], id: "appointment-form" do |f| %>
        <div class="modal-body">
          <%= f.hidden_field :start_time, id: "start_time_field" %>
          <%= f.hidden_field :end_time, id: "end_time_field" %>
          <%= f.hidden_field :dog_id, value: @dog.id %>

          <div class="mb-3">
            <label class="form-label fw-bold">Selected Time</label>
            <input type="text" class="form-control-plaintext" id="selected_time_display" readonly>
          </div>

          <div class="mb-3">
            <%= f.label :title, class: "form-label" %>
            <%= f.text_field :title, class: "form-control", placeholder: "Appointment title", required: true %>
          </div>

          <div class="mb-3">
            <%= f.label :host, "Host Name", class: "form-label" %>
            <%= f.text_field :host, class: "form-control", required: true %>
          </div>

          <div class="mb-3">
            <%= f.label :appointment_type, "Type", class: "form-label" %>
            <%= f.select :appointment_type,
                options_for_select([
                  ['Grooming', 'Grooming'],
                  ['Veterinarian', 'Veterinarian'],
                  ['Dogwalker', 'Dogwalker'],
                  ['Playdate', 'Playdate'],
                  ['Other', 'Other']
                ]),
                { prompt: "Select type" },
                { class: "form-select", required: true } %>
          </div>

          <div class="mb-3">
            <%= f.label :location, "Location", class: "form-label" %>
            <%= f.text_area :location, class: "form-control", rows: 2, required: true %>
          </div>

          <div class="mb-3">
            <%= f.label :appointment_notes, "Notes", class: "form-label" %>
            <%= f.text_area :appointment_notes, class: "form-control", rows: 3 %>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= f.submit "Create", class: "btn btn-warning", style: "min-width: 120px;" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('turbo:load', function() {
    var calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    var modalEl = document.getElementById('appointmentModal');
    var modal = modalEl ? new bootstrap.Modal(modalEl) : null;

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'listWeek',

      headerToolbar: {
        left: 'prev,next',           // Just navigation arrows
        center: 'title',
        right: 'timeGridWeek,listWeek'  // Just Week and List
      },

      buttonText: {
        week: 'Week',
        list: 'List'
      },

      selectable: true,
      selectMirror: true,

      dateClick: function(info) {
        if (!modal) return;

        var startTime = new Date(info.date);
        var endTime = new Date(startTime.getTime() + 3600000);

        document.getElementById('start_time_field').value = startTime.toISOString();
        document.getElementById('end_time_field').value = endTime.toISOString();

        var displayText = startTime.toLocaleString('en-GB', {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) + ' - ' + endTime.toLocaleTimeString('en-GB', {
          hour: '2-digit',
          minute: '2-digit'
        });

        document.getElementById('selected_time_display').value = displayText;

        var inputs = document.querySelectorAll('#appointment-form input:not([type="hidden"]), #appointment-form textarea, #appointment-form select');
        inputs.forEach(function(input) {
          if (input.id !== 'selected_time_display') {
            input.value = '';
          }
        });

        modal.show();
      },

      select: function(info) {
        if (!modal) return;

        document.getElementById('start_time_field').value = info.startStr;
        document.getElementById('end_time_field').value = info.endStr;

        var startTime = new Date(info.start);
        var endTime = new Date(info.end);
        var displayText = startTime.toLocaleString('en-GB', {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) + ' - ' + endTime.toLocaleTimeString('en-GB', {
          hour: '2-digit',
          minute: '2-digit'
        });

        document.getElementById('selected_time_display').value = displayText;

        var inputs = document.querySelectorAll('#appointment-form input:not([type="hidden"]), #appointment-form textarea, #appointment-form select');
        inputs.forEach(function(input) {
          if (input.id !== 'selected_time_display') {
            input.value = '';
          }
        });

        modal.show();
        calendar.unselect();
      },

      events: <%= raw @appointments.map { |appointment| {
        id: appointment.id,
        title: "#{appointment.host} - #{appointment.dog.name}",
        start: appointment.start_time.iso8601,
        end: appointment.end_time.iso8601,
        url: appointment_path(appointment)
      }}.to_json %>,

      eventClick: function(info) {
        info.jsEvent.preventDefault();
        if (info.event.url) {
          window.location.href = info.event.url;
        }
      },

      slotMinTime: '08:00:00',
      slotMaxTime: '20:00:00',
      allDaySlot: false,
      slotDuration: '00:30:00',

      eventColor: '#4A90E2',
      height: 'auto',

      nowIndicator: true,
      scrollTime: '08:00:00'
    });

    calendar.render();
  });
</script>
