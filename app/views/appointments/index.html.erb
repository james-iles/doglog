<div class="container-fluid p-0">
  <div class="row justify-content-center">
    <div class="col-sm-10 my-3">
      <%= form_with url: dog_appointments_path,
                    method: :get,
                    data: {
                      turbo_frame: "appointments_list",
                      turbo_action: "advance",
                      controller: "search-form"
                    },
                    class: "row g-2 align-items-end" do %>

        <div class="col-md-5">
           <%= text_field_tag :query,
                params[:query],
                class: "form-control",
                placeholder: "Search with keywords...",
                data: { action: "input->search-form#submit" }
            %>
        </div>

        <div class="col-md-4">
          <%= select_tag :appointment_type,
              options_for_select([
                ['All Categories', 'all'],
                ['Treeming', 'Treeming'],
                ['Veterinarian', 'Veterinarian'],
                ['Dogwalker', 'Dogwalker'],
                ['Playdate', 'Playdate'],
                ['Other', 'Other']
              ], params[:appointment_type] || 'all'),
              class: "form-select",
              data: { action: "change->search-form#submit" } %>
        </div>

        <div class="col-md-2">
          <%= submit_tag "Search", name: "", class: "btn btn-primary w-100" %>
        </div>

        <div class="col-md-1">
          <%= link_to "Clear",
              dog_appointments_path,
              class: "btn btn-secondary w-100",
              data: { turbo_frame: "appointments_list" },
              title: "Clear all filters" %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="px-2 py-3">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-3">
      <div>
        <h1 class="h4 mb-0">Appointments</h1>
        <p class="text-muted small mb-0">Click on a time slot to create a new appointment</p>
      </div>
      <%= link_to "New Appointment", new_dog_appointment_path, class: "btn btn-primary" %>
    </div>

    <div id='calendar'></div>
  </div>
</div>

<!-- Modal for creating new appointment -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Appointment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <%= form_with model: [@dog, Appointment.new], id: "appointment-form" do |f| %>
        <div class="modal-body">
          <%= f.hidden_field :start_time, id: "start_time_field" %>
          <%= f.hidden_field :end_time, id: "end_time_field" %>
          <%= f.hidden_field :dog_id, value: @dog.id %>

          <div class="mb-3">
            <label class="form-label fw-bold">Selected Time</label>
            <input type="text" class="form-control-plaintext" id="selected_time_display" readonly>
          </div>

          <div class="mb-3">
            <%= f.label :title, class: "form-label" %>
            <%= f.text_field :title, class: "form-control", placeholder: "Appointment title" %>
          </div>

          <div class="mb-3">
            <%= f.label :host, "Host Name", class: "form-label" %>
            <%= f.text_field :host, class: "form-control", required: true %>
          </div>

          <div class="mb-3">
            <%= f.label :appointment_type, "Type", class: "form-label" %>
            <%= f.select :appointment_type,
                options_for_select([
                  ['Treeming', 'Treeming'],
                  ['Veterinarian', 'Veterinarian'],
                  ['Dogwalker', 'Dogwalker'],
                  ['Playdate', 'Playdate'],
                  ['Other', 'Other']
                ]),
                { prompt: "Select type" },
                { class: "form-select", required: true } %>
          </div>

          <div class="mb-3">
            <%= f.label :location, "Location", class: "form-label" %>
            <%= f.text_area :location, class: "form-control", rows: 2 %>
          </div>

          <div class="mb-3">
            <%= f.label :appointment_notes, "Notes", class: "form-label" %>
            <%= f.text_area :appointment_notes, class: "form-control", rows: 3 %>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= f.submit "Create Appointment", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('turbo:load', function() {
    var calendarEl = document.getElementById('calendar');

    if (!calendarEl) return;

    // Initialize Bootstrap modal
    var modalEl = document.getElementById('appointmentModal');
    var modal = modalEl ? new bootstrap.Modal(modalEl) : null;

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'listWeek',

      headerToolbar: {
        left: 'prev,next',
        center: 'title',
        right: 'today,timeGridWeek,listWeek'
      },

      buttonText: {
        today: 'Today',
        week: 'Week',
        list: 'List'
      },

      height: 'auto',
      contentHeight: 'auto',

      // ENABLE CLICK TO CREATE
      selectable: true,
      selectMirror: true,

      // When user clicks on a time slot
      select: function(info) {
        if (modal) {
          // Set the hidden fields with selected times
          document.getElementById('start_time_field').value = info.startStr;
          document.getElementById('end_time_field').value = info.endStr;

          // Format and display the selected time nicely
          var startTime = new Date(info.start);
          var endTime = new Date(info.end);
          var displayText = startTime.toLocaleString('en-GB', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) + ' - ' + endTime.toLocaleTimeString('en-GB', {
            hour: '2-digit',
            minute: '2-digit'
          });

          document.getElementById('selected_time_display').value = displayText;

          // Clear other form fields but keep the times
          var form = document.getElementById('appointment-form');
          var inputs = form.querySelectorAll('input:not([type="hidden"]), textarea, select');
          inputs.forEach(input => {
            if (input.id !== 'selected_time_display') {
              input.value = '';
            }
          });

          // Show the modal
          modal.show();
        }

        // Unselect the calendar
        calendar.unselect();
      },

      events: <%= raw @appointments.map { |appointment| {
        id: appointment.id,
        title: "#{appointment.host} - #{appointment.dog.name}",
        start: appointment.start_time.iso8601,
        end: appointment.end_time.iso8601,
        url: appointment_path(appointment)
      }}.to_json %>,

      eventClick: function(info) {
        info.jsEvent.preventDefault();
        if (info.event.url) {
          window.location.href = info.event.url;
        }
      },

      eventTimeFormat: {
        hour: 'numeric',
        minute: '2-digit',
        meridiem: 'short'
      },

      views: {
        listWeek: {
          listDayFormat: { weekday: 'short', month: 'short', day: 'numeric' },
          noEventsContent: 'No appointments this week'
        }
      },

      eventColor: '#4A90E2',
      handleWindowResize: true,

      // Time settings for week view
      slotMinTime: '08:00:00',
      slotMaxTime: '20:00:00',
      allDaySlot: false
    });

    calendar.render();

    // Force proper sizing
    setTimeout(() => {
      calendar.updateSize();
      calendarEl.style.maxWidth = '100%';
      calendarEl.style.width = '100%';
    }, 100);
  });
</script>
